<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flow Graph Simulator Replay</title>
  <style>
    :root {
      --bg: #0f1220;
      --panel: #171b2e;
      --ink: #e8ecff;
      --muted: #a4afd8;
      --accent: #67d3ff;
      --warn: #ffb357;
    }
    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Noto Sans", sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #1b2140, var(--bg));
      color: var(--ink);
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 16px;
    }
    .panel {
      background: linear-gradient(180deg, #1a1f35, var(--panel));
      border: 1px solid #2a3259;
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.25);
    }
    h1 {
      grid-column: 1 / -1;
      margin: 0;
      font-size: 20px;
    }
    #canvas {
      width: 100%;
      height: 620px;
      background: #0b1022;
      border-radius: 10px;
      border: 1px solid #273058;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    input[type="range"] { width: 100%; }
    .kpis {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .kpi {
      background: #101631;
      border: 1px solid #29325f;
      border-radius: 10px;
      padding: 8px;
    }
    .kpi .label {
      color: var(--muted);
      font-size: 12px;
    }
    .kpi .val {
      font-size: 16px;
      font-weight: 700;
    }
    .list {
      font-family: "IBM Plex Mono", "Consolas", monospace;
      font-size: 12px;
      line-height: 1.45;
      color: #c9d2ff;
      max-height: 200px;
      overflow: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Flow Graph Dynamic Replay</h1>
    <div class="panel">
      <canvas id="canvas" width="780" height="620"></canvas>
      <div class="row">
        <span>Step</span>
        <input id="step" type="range" min="0" max="0" value="0" />
        <strong id="stepLabel">1</strong>
      </div>
    </div>
    <div class="panel">
      <div class="kpis">
        <div class="kpi"><div class="label">Objective</div><div id="obj" class="val">-</div></div>
        <div class="kpi"><div class="label">Critical</div><div id="crit" class="val">-</div></div>
        <div class="kpi"><div class="label">Warning</div><div id="warn" class="val">-</div></div>
        <div class="kpi"><div class="label">Scale</div><div id="scale" class="val">-</div></div>
        <div class="kpi"><div class="label">Horizon</div><div id="horizon" class="val">-</div></div>
        <div class="kpi"><div class="label">Budget</div><div id="budget" class="val">-</div></div>
      </div>
      <h3>Top Final Node Values</h3>
      <div id="topNodes" class="list"></div>
      <h3>Edge Deltas</h3>
      <div id="edgeDeltas" class="list"></div>
    </div>
  </div>
  <script>
    const DATA = {"frame_count": 2, "layout": {"a": [0.29614544618750993, -0.1341366008476921], "b": [-0.5645862734885699, 0.6585800849927078], "c": [0.9385949911611307, -0.1438337616725473], "d": [0.013584965863403738, -0.7465435911200023], "e": [-1.0, -0.1411807735885688], "hub": [0.3162608702765253, 0.507114642236103]}, "frames": [{"step": 1, "objective_score": 3.803301, "critical_transition_score": 0.0, "early_warning_score": 0.0, "adjustment_scale": 1.2, "planner_horizon": 4, "edit_budget": 0, "node_impacts": {"hub": 1.75, "a": 0.625, "b": 0.625, "c": 0.625, "d": 0.625, "e": 0.375}, "node_controls": {"a": 0.164151, "b": -0.018073, "c": 0.167301, "d": -0.225586, "e": -0.123242, "hub": -1.0}, "node_final_values": {"a": 0.577564, "b": 0.61054, "c": 0.580714, "d": 0.187827, "e": 0.255371, "hub": 0.538413}, "edges": [{"source_id": "hub", "target_id": "a", "weight": 1.173978}, {"source_id": "hub", "target_id": "b", "weight": 1.075066}, {"source_id": "hub", "target_id": "c", "weight": 0.974082}, {"source_id": "a", "target_id": "d", "weight": 0.662409}, {"source_id": "b", "target_id": "e", "weight": 0.765726}, {"source_id": "c", "target_id": "d", "weight": 0.562512}, {"source_id": "d", "target_id": "e", "weight": 0.451776}], "top_impacts": [["hub", 1.75], ["a", 0.625], ["b", 0.625], ["c", 0.625], ["d", 0.625]], "top_controls": [["hub", -1.0], ["d", -0.225586], ["c", 0.167301], ["a", 0.164151], ["e", -0.123242]], "top_final_nodes": [["b", 0.61054], ["c", 0.580714], ["a", 0.577564], ["hub", 0.538413], ["e", 0.255371]], "edge_deltas": [{"source_id": "b", "target_id": "hub", "kind": "weight", "old_weight": 1.0, "new_weight": 1.075066}, {"source_id": "c", "target_id": "hub", "kind": "weight", "old_weight": 0.9, "new_weight": 0.974082}, {"source_id": "a", "target_id": "hub", "kind": "weight", "old_weight": 1.1, "new_weight": 1.173978}, {"source_id": "b", "target_id": "e", "kind": "weight", "old_weight": 0.7, "new_weight": 0.765726}, {"source_id": "c", "target_id": "d", "kind": "weight", "old_weight": 0.5, "new_weight": 0.562512}, {"source_id": "a", "target_id": "d", "kind": "weight", "old_weight": 0.6, "new_weight": 0.662409}, {"source_id": "d", "target_id": "e", "kind": "weight", "old_weight": 0.4, "new_weight": 0.451776}]}, {"step": 2, "objective_score": 3.805922, "critical_transition_score": 0.15, "early_warning_score": 0.0, "adjustment_scale": 1.2, "planner_horizon": 4, "edit_budget": 0, "node_impacts": {"hub": 1.75, "a": 0.625, "b": 0.625, "c": 0.625, "d": 0.625, "e": 0.375}, "node_controls": {"a": 0.15275, "b": -0.0194, "c": 0.156063, "d": -0.230455, "e": -0.122689, "hub": -1.0}, "node_final_values": {"a": 0.571837, "b": 0.602778, "c": 0.57515, "d": 0.188632, "e": 0.249489, "hub": 0.544087}, "edges": [{"source_id": "hub", "target_id": "a", "weight": 1.24194}, {"source_id": "hub", "target_id": "b", "weight": 1.143998}, {"source_id": "hub", "target_id": "c", "weight": 1.042148}, {"source_id": "a", "target_id": "d", "weight": 0.719221}, {"source_id": "b", "target_id": "e", "weight": 0.825418}, {"source_id": "c", "target_id": "d", "weight": 0.619428}, {"source_id": "d", "target_id": "e", "weight": 0.498478}], "top_impacts": [["hub", 1.75], ["a", 0.625], ["b", 0.625], ["c", 0.625], ["d", 0.625]], "top_controls": [["hub", -1.0], ["d", -0.230455], ["c", 0.156063], ["a", 0.15275], ["e", -0.122689]], "top_final_nodes": [["b", 0.602778], ["c", 0.57515], ["a", 0.571837], ["hub", 0.544087], ["e", 0.249489]], "edge_deltas": [{"source_id": "b", "target_id": "hub", "kind": "weight", "old_weight": 1.075066, "new_weight": 1.143998}, {"source_id": "c", "target_id": "hub", "kind": "weight", "old_weight": 0.974082, "new_weight": 1.042148}, {"source_id": "a", "target_id": "hub", "kind": "weight", "old_weight": 1.173978, "new_weight": 1.24194}, {"source_id": "b", "target_id": "e", "kind": "weight", "old_weight": 0.765726, "new_weight": 0.825418}, {"source_id": "c", "target_id": "d", "kind": "weight", "old_weight": 0.562512, "new_weight": 0.619428}, {"source_id": "a", "target_id": "d", "kind": "weight", "old_weight": 0.662409, "new_weight": 0.719221}, {"source_id": "d", "target_id": "e", "kind": "weight", "old_weight": 0.451776, "new_weight": 0.498478}]}]};
    const frames = DATA.frames || [];
    const layout = DATA.layout || {};
    const nodeIds = Object.keys(layout);
    const slider = document.getElementById("step");
    slider.max = Math.max(0, frames.length - 1);
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    function mapPoint(x, y) {
      const px = 80 + (x + 1) * 0.5 * (canvas.width - 160);
      const py = 80 + (y + 1) * 0.5 * (canvas.height - 160);
      return [px, py];
    }

    function drawFrame(i) {
      const f = frames[i];
      if (!f) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#0b1022";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const finalVals = f.node_final_values || {};
      const controls = f.node_controls || {};
      const edges = f.edges || [];

      // edges
      for (const e of edges) {
        const a = layout[e.source_id];
        const b = layout[e.target_id];
        if (!a || !b) continue;
        const [x1, y1] = mapPoint(a[0], a[1]);
        const [x2, y2] = mapPoint(b[0], b[1]);
        ctx.strokeStyle = "rgba(148,165,255,0.35)";
        ctx.lineWidth = 1 + Math.min(4, e.weight * 0.9);
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      }

      // nodes
      for (const n of nodeIds) {
        const p = layout[n];
        const [x, y] = mapPoint(p[0], p[1]);
        const v = Number(finalVals[n] || 0);
        const c = Number(controls[n] || 0);
        const r = 8 + Math.min(18, v * 6);
        const hue = c >= 0 ? 195 : 28;
        const sat = 70;
        const lit = 42 + Math.min(35, Math.abs(c) * 40);
        ctx.fillStyle = `hsl(${hue} ${sat}% ${lit}%)`;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "rgba(240,245,255,0.75)";
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.fillStyle = "#ecf1ff";
        ctx.font = "12px IBM Plex Mono, monospace";
        ctx.fillText(`${n} (${v.toFixed(2)})`, x + r + 4, y + 4);
      }

      document.getElementById("stepLabel").textContent = String(f.step);
      document.getElementById("obj").textContent = f.objective_score.toFixed(4);
      document.getElementById("crit").textContent = f.critical_transition_score.toFixed(4);
      document.getElementById("warn").textContent = f.early_warning_score.toFixed(4);
      document.getElementById("scale").textContent = f.adjustment_scale.toFixed(2);
      document.getElementById("horizon").textContent = String(f.planner_horizon);
      document.getElementById("budget").textContent = String(f.edit_budget);

      document.getElementById("topNodes").textContent = (f.top_final_nodes || [])
        .map(([n, v]) => `${n}: ${Number(v).toFixed(4)}`)
        .join("\n");
      document.getElementById("edgeDeltas").textContent = (f.edge_deltas || [])
        .map(d => `${d.source_id}-${d.target_id}  ${d.kind}  ${Number(d.old_weight).toFixed(3)} -> ${Number(d.new_weight).toFixed(3)}`)
        .join("\n");
    }

    slider.addEventListener("input", () => drawFrame(Number(slider.value)));
    drawFrame(0);
  </script>
</body>
</html>